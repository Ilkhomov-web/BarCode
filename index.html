<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gilam Baza Pro | 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #6366f1;
        --bg: #f8fafc;
        --card: #ffffff;
        --text-main: #1e293b;
        --text-sub: #64748b;
        --success: #22c55e;
        --danger: #ef4444;
        --border: #e2e8f0;
      }

      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: var(--bg);
        margin: 0;
        padding: 20px;
        color: var(--text-main);
      }

      .main-container {
        max-width: 1100px;
        margin: 0 auto;
      }

      .glass-card {
        background: var(--card);
        padding: 24px;
        border-radius: 24px;
        border: 1px solid var(--border);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        margin-bottom: 24px;
      }

      .input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        align-items: end;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        position: relative;
      }
      label {
        font-size: 11px;
        font-weight: 800;
        color: var(--text-sub);
        text-transform: uppercase;
      }

      input,
      select {
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-weight: 600;
        outline: none;
        transition: 0.2s;
        font-size: 14px;
      }

      input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      }

      .btn {
        padding: 12px 20px;
        border-radius: 12px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: 0.2s;
        font-size: 14px;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
      }

      .history-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
        border-radius: 20px;
        overflow: hidden;
        border: 1px solid var(--border);
      }

      .history-table th {
        background: #f8fafc;
        padding: 16px;
        text-align: left;
        font-size: 12px;
        color: var(--text-sub);
        border-bottom: 1px solid var(--border);
      }
      .history-table td {
        padding: 14px 16px;
        border-bottom: 1px solid #f1f5f9;
      }

      .badge {
        background: #eef2ff;
        color: var(--primary);
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 700;
      }

      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(8px);
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 28px;
        width: 90%;
        max-width: 380px;
        text-align: center;
        transform: scale(0.9);
        transition: 0.3s;
      }

      .modal.show .modal-content {
        transform: scale(1);
      }

      .barcode-box {
        background: #fff;
        border: 2px dashed var(--border);
        padding: 15px;
        border-radius: 20px;
        margin: 20px 0;
        min-height: 120px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #previewSvg {
        width: 100%;
        height: auto;
      }

      #printArea {
        display: none;
      }
      @media print {
        body * {
          visibility: hidden;
        }
        #printArea,
        #printArea * {
          visibility: visible;
        }
        #printArea {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          display: block !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="glass-card">
        <h2
          style="
            margin: 0 0 20px 0;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
          "
        >
          EAG Barcode
        </h2>
        <div class="input-grid">
          <div class="form-group">
            <label>Sifat</label>
            <select id="carpetName">
              <option value="1">Mashhad</option>
              <option value="2">Aladin</option>
              <option value="3">Zeekr</option>
              <option value="4">Buxoro</option>
            </select>
          </div>
          <div class="form-group">
            <label>Nusxa (Design)</label>
            <input
              type="text"
              id="designCode"
              placeholder="8550"
              maxlength="4"
            />
          </div>
          <div class="form-group">
            <label>Rang kodi</label>
            <input
              type="text"
              id="carpetColor"
              placeholder="0037"
              maxlength="4"
            />
          </div>
          <div class="form-group">
            <label>O'lchami</label>
            <input type="text" id="carpetSize" placeholder="400x500" />
          </div>
          <button class="btn btn-primary" onclick="addNewBarcode()">
            <i data-lucide="plus-circle"></i> Qo'shish
          </button>
        </div>
      </div>

      <div class="form-group" style="margin-bottom: 15px">
        <input
          type="text"
          id="searchInput"
          onkeyup="renderHistory()"
          placeholder="Qidiruv (Sifat, Nusxa, Rang)..."
          style="width: 100%; box-sizing: border-box; background: white"
        />
      </div>

      <div class="glass-card" style="padding: 0; overflow: hidden">
        <table class="history-table">
          <thead>
            <tr>
              <th>Sifat</th>
              <th>Nusxa</th>
              <th>Rang</th>
              <th>O'lcham</th>
              <th>Barcode</th>
              <th style="text-align: right">Amallar</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>

    <div id="viewModal" class="modal" onclick="closeModal()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="modalTitle" style="margin: 0"></h3>
        <p
          id="modalSub"
          style="color: var(--text-sub); margin: 5px 0; font-size: 14px"
        ></p>
        <div class="barcode-box">
          <svg id="previewSvg"></svg>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
          <button
            class="btn"
            style="background: #f1f5f9"
            onclick="closeModal()"
          >
            Yopish
          </button>
          <button
            class="btn"
            style="background: var(--success); color: white"
            onclick="printFromModal()"
          >
            <i data-lucide="printer"></i> Chiqarish
          </button>
        </div>
      </div>
    </div>

    <div id="printArea"></div>

    <script>
      let db;
      let currentItem = null;

      // IndexedDB initialization
      const request = indexedDB.open("CarpetFinalDB", 2); // Versiyani oshirdik
      request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("carpets")) {
          db.createObjectStore("carpets", {
            keyPath: "id",
            autoIncrement: true,
          });
        }
      };
      request.onsuccess = (e) => {
        db = e.target.result;
        renderHistory();
      };

      // O'lchami uchun hash generatsiya (Senior Algorithm)
      function generateSizeId(sizeStr) {
        let hash = 0;
        const cleanSize = sizeStr.replace(/\s+/g, "").toLowerCase();
        for (let i = 0; i < cleanSize.length; i++) {
          hash = (hash << 5) - hash + cleanSize.charCodeAt(i);
          hash |= 0;
        }
        return Math.abs(hash % 100)
          .toString()
          .padStart(2, "0");
      }

      function calculateEAN(base) {
        let sum = 0;
        for (let i = 0; i < 12; i++) {
          sum += parseInt(base[i]) * (i % 2 === 0 ? 1 : 3);
        }
        return (10 - (sum % 10)) % 10;
      }

      function addNewBarcode() {
        const nameSelect = document.getElementById("carpetName");
        const designRaw = document.getElementById("designCode").value.trim();
        const colorRaw = document.getElementById("carpetColor").value.trim();
        const sizeRaw = document.getElementById("carpetSize").value.trim();

        if (!designRaw || !colorRaw || !sizeRaw) {
          alert("⚠️ Iltimos, barcha maydonlarni to'ldiring!");
          return;
        }

        // --- NORMALIZATSIYA (MUHIM!) ---
        // Foydalanuvchi "37" yozsa ham, "0037" yozsa ham bazada "0037" bo'lib saqlanadi.
        const cleanDesign = designRaw.replace(/\D/g, "").padStart(4, "0");
        const cleanColor = colorRaw.replace(/\D/g, "").padStart(4, "0");
        const cleanSize = sizeRaw.replace(/\s+/g, "").toLowerCase();

        // Barcode generatsiyasi
        const typePart = nameSelect.value.padStart(2, "0");
        const designPartForBarcode = cleanDesign.slice(-3);
        const colorPartForBarcode = cleanColor.slice(-3);
        const sizePartForBarcode = generateSizeId(cleanSize);

        const baseCode =
          "20" +
          typePart +
          designPartForBarcode +
          colorPartForBarcode +
          sizePartForBarcode;
        const fullCode = baseCode + calculateEAN(baseCode);

        // Dublikatni tekshirish
        const tx = db.transaction("carpets", "readonly");
        const store = tx.objectStore("carpets");

        store.getAll().onsuccess = (e) => {
          const items = e.target.result;
          const isDuplicate = items.some(
            (item) =>
              item.name === nameSelect.options[nameSelect.selectedIndex].text &&
              item.design === cleanDesign &&
              item.color === cleanColor &&
              item.size.replace(/\s+/g, "").toLowerCase() === cleanSize
          );

          if (isDuplicate) {
            alert(
              `❌ BU TOVAR ALLAQACHON MAVJUD!\n\n${
                nameSelect.options[nameSelect.selectedIndex].text
              } | Nusxa: ${cleanDesign} | Rang: ${cleanColor} | O'lcham: ${sizeRaw}`
            );
            document.getElementById("searchInput").value = cleanDesign;
            renderHistory();
            return;
          }

          // Yangi tovar qo'shish
          const newItem = {
            name: nameSelect.options[nameSelect.selectedIndex].text,
            design: cleanDesign, // Normalizatsiya qilingan
            color: cleanColor, // Normalizatsiya qilingan
            size: sizeRaw, // Ko'rinish uchun asl holi
            barcode: fullCode,
            time: Date.now(),
          };

          const txAdd = db.transaction("carpets", "readwrite");
          txAdd.objectStore("carpets").add(newItem);
          txAdd.oncomplete = () => {
            renderHistory();
            ["designCode", "carpetColor", "carpetSize"].forEach(
              (id) => (document.getElementById(id).value = "")
            );
          };
        };
      }

      function renderHistory() {
        const search = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const tbody = document.getElementById("historyBody");
        tbody.innerHTML = "";

        db.transaction("carpets").objectStore("carpets").getAll().onsuccess = (
          e
        ) => {
          const items = e.target.result.sort((a, b) => b.time - a.time);
          items.forEach((item) => {
            if (
              `${item.name} ${item.design} ${item.color} ${item.barcode}`
                .toLowerCase()
                .includes(search)
            ) {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td><b>${item.name}</b></td>
                <td><span class="badge">${item.design}</span></td>
                <td>${item.color}</td>
                <td>${item.size}</td>
                <td><code>${item.barcode}</code></td>
                <td style="text-align: right; display: flex; gap: 8px; justify-content: flex-end;">
                  <button class="btn" style="background:#f1f5f9; padding:6px 10px" onclick='viewBarcode(${JSON.stringify(
                    item
                  )})'>
                    <i data-lucide="eye" style="width:16px"></i>
                  </button>
                  <button class="btn" style="background:#fff1f2; color:var(--danger); padding:6px 10px" onclick="deleteItem(${
                    item.id
                  })">
                    <i data-lucide="trash-2" style="width:16px"></i>
                  </button>
                </td>`;
              tbody.appendChild(tr);
            }
          });
          lucide.createIcons();
        };
      }

      function deleteItem(id) {
        if (confirm("Haqiqatdan ham o'chirmoqchimisiz?")) {
          const tx = db.transaction("carpets", "readwrite");
          tx.objectStore("carpets").delete(id);
          tx.oncomplete = () => renderHistory();
        }
      }

      function viewBarcode(item) {
        currentItem = item;
        const modal = document.getElementById("viewModal");
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("show"), 10);

        document.getElementById(
          "modalTitle"
        ).innerText = `${item.name} | Nusxa: ${item.design}`;
        document.getElementById(
          "modalSub"
        ).innerText = `Rang: ${item.color} • O'lcham: ${item.size}`;

        setTimeout(() => {
          JsBarcode("#previewSvg", item.barcode, {
            format: "EAN13",
            width: 2.5,
            height: 80,
            displayValue: true,
            fontSize: 16,
          });
        }, 150);
      }

      function closeModal() {
        const modal = document.getElementById("viewModal");
        modal.classList.remove("show");
        setTimeout(() => (modal.style.display = "none"), 300);
      }

      function printFromModal() {
        const area = document.getElementById("printArea");
        area.innerHTML = `
          <div style="text-align:center; padding:15px; border:1px solid #000; display:inline-block; font-family: sans-serif;">
            <div style="font-size: 18px; font-weight: bold;">${currentItem.name}</div>
            <div style="font-size: 12px; margin: 5px 0;">Nusxa: ${currentItem.design} | Rang: ${currentItem.color} | O'lcham: ${currentItem.size}</div>
            <svg id="pSvg"></svg>
          </div>`;
        JsBarcode("#pSvg", currentItem.barcode, {
          format: "EAN13",
          width: 2,
          height: 60,
        });
        setTimeout(() => {
          window.print();
        }, 200);
      }

      lucide.createIcons();
    </script>
  </body>
</html>
